function restructureChatBoxes() {
    align = 0;
    for (x in chatBoxes) {
        chatboxtitle = chatBoxes[x];
        if ($("#chatbox_" + chatboxtitle).css("display") != "none") {
            if (align == 0) {
                $("#chatbox_" + chatboxtitle).css("right", "20px")
            } else {
                width = align * (225 + 7) + 20;
                $("#chatbox_" + chatboxtitle).css("right", width + "px")
            }
            align++
        }
    }
}

function blingBling(username) {
    document.title = 'New Message from ' + username;
    //$.playSound('http://app.aakasha.com/app/templates/sbydev_realdark/sound/yoda.mp3');
}

function chatWith(e) {
    createChatBox(e);
    $("#chatbox_" + e + " .chatboxtextarea").focus()
}

function createChatBox(e, t) {
    if ($("#chatbox_" + e).length > 0) {
        if ($("#chatbox_" + e).css("display") == "none") {
            $("#chatbox_" + e).css("display", "block");
            restructureChatBoxes()
        }
        $("#chatbox_" + e + " .chatboxtextarea").focus();
        return
    }
    $.post("/chat/chatfetchstatus", {
        username: e
    }, function(data) {
        $("#" + e + "_status").html(data);
    });
    $("<div />").attr("id", "chatbox_" + e).addClass("chatbox").html('<div class="chatboxhead"><div class="chatboxtitle"><span id="' + e + '_status"></span>' + e + '</div><div class="chatboxoptions"><a href="javascript:void(0)" onclick="javascript:toggleChatBoxGrowth(\'' + e + '\')">â€“</a>&nbsp; <a href="javascript:void(0)" onclick="javascript:closeChatBox(\'' + e + '\')">X</a></div><br clear="all"/></div><div class="chatboxcontent"></div><div class="chatboxinput"><textarea class="chatboxtextarea" onkeydown="javascript:return checkChatBoxInputKey(event,this,\'' + e + "');\"></textarea></div>").appendTo($("body"));
    $("#chatbox_" + e).css("bottom", "0px");
    chatBoxeslength = 0;
    for (x in chatBoxes) {
        if ($("#chatbox_" + chatBoxes[x]).css("display") != "none") {
            chatBoxeslength++
        }
    }
    if (chatBoxeslength == 0) {
        $("#chatbox_" + e).css("right", "20px")
    } else {
        width = chatBoxeslength * (225 + 7) + 20;
        $("#chatbox_" + e).css("right", width + "px")
    }
    chatBoxes.push(e);
    if (t == 1) {
        minimizedChatBoxes = new Array;
        if ($.cookie("chatbox_minimized")) {
            minimizedChatBoxes = $.cookie("chatbox_minimized").split(/\|/)
        }
        minimize = 0;
        for (j = 0; j < minimizedChatBoxes.length; j++) {
            if (minimizedChatBoxes[j] == e) {
                minimize = 1
            }
        }
        if (minimize == 1) {
            $("#chatbox_" + e + " .chatboxcontent").css("display", "none");
            $("#chatbox_" + e + " .chatboxinput").css("display", "none")
        }
    }
    chatboxFocus[e] = false;
    $("#chatbox_" + e + " .chatboxtextarea").blur(function() {
        chatboxFocus[e] = false;
        $("#chatbox_" + e + " .chatboxtextarea").removeClass("chatboxtextareaselected")
    }).focus(function() {
        chatboxFocus[e] = true;
        newMessages[e] = false;
        $("#chatbox_" + e + " .chatboxhead").removeClass("chatboxblink");
        $("#chatbox_" + e + " .chatboxtextarea").addClass("chatboxtextareaselected")
    });
    $("#chatbox_" + e).click(function() {
        if ($("#chatbox_" + e + " .chatboxcontent").css("display") != "none") {
            $("#chatbox_" + e + " .chatboxtextarea").focus()
        }
    });
    $("#chatbox_" + e).show()
}

function chatHeartbeat() {
    
    var e = 0;
    if (windowFocus == false) {
        var t = 0;
        var n = 0;
        for (x in newMessagesWin) {
            if (newMessagesWin[x] == true) {
                ++t;
                if (t >= blinkOrder) {
                    document.title = x + " says...";
                    n = 1;
                    break
                }
            }
        }
        if (n == 0) {
            document.title = originalTitle;
            blinkOrder = 0
        } else {
            ++blinkOrder
        }
    } else {
        for (x in newMessagesWin) {
            newMessagesWin[x] = false
        }
    }
    for (x in newMessages) {
        if (newMessages[x] == true) {
            if (chatboxFocus[x] == false) {
                $("#chatbox_" + x + " .chatboxhead").toggleClass("chatboxblink")
            }
        }
    }
    $.ajax({
        url: "/chat/chatheartbeat",
        cache: false,
        dataType: "json",
        success: function(t) {
            $.each(t.items, function(t, n) {
                if (n && (typeof(n.f) !== "undefined")) {
                    chatboxtitle = n.f;
                    if ($("#chatbox_" + chatboxtitle).length <= 0) {
                        createChatBox(chatboxtitle)
                    }
                    if ($("#chatbox_" + chatboxtitle).css("display") == "none") {
                        $("#chatbox_" + chatboxtitle).css("display", "block");
                        restructureChatBoxes()
                    }
                    if (n.s == 1) {
                        n.f = username
                    }
                    if (n.s == 2) {
                        $("#chatbox_" + chatboxtitle + " .chatboxcontent").append('<div class="chatboxmessage"><span class="chatboxinfo">' + n.m + "</span></div>")
                    } else {
                        blingBling(n.f); //make tab to bling
                        newMessages[chatboxtitle] = true;
                        newMessagesWin[chatboxtitle] = true;
                        $("#chatbox_" + chatboxtitle + " .chatboxcontent").append('<div class="chatboxmessage"><span class="chatboxmessagefrom">' + n.f + ':&nbsp;&nbsp;</span><span class="chatboxmessagecontent">' + n.m + "</span></div>")
                    }
                    $("#chatbox_" + chatboxtitle + " .chatboxcontent").scrollTop($("#chatbox_" + chatboxtitle + " .chatboxcontent")[0].scrollHeight);
                    e += 1
                }
            });
            chatHeartbeatCount++;
            if (e > 0) {
                chatHeartbeatTime = minChatHeartbeat;
                chatHeartbeatCount = 1
            } else if (chatHeartbeatCount >= 10) {
                chatHeartbeatTime *= 2;
                chatHeartbeatCount = 1;
                if (chatHeartbeatTime > maxChatHeartbeat) {
                    chatHeartbeatTime = maxChatHeartbeat
                }
            }
            setTimeout("chatHeartbeat();", chatHeartbeatTime)
        }
    })
}

function closeChatBox(e) {
    $("#chatbox_" + e).css("display", "none");
    restructureChatBoxes();
    $.post("/chat/closechat", {
        chatbox: e
    }, function(e) {})
}

function toggleChatBoxGrowth(e) {
    if ($("#chatbox_" + e + " .chatboxcontent").css("display") == "none") {
        var t = new Array;
        if ($.cookie("chatbox_minimized")) {
            t = $.cookie("chatbox_minimized").split(/\|/)
        }
        var n = "";
        for (i = 0; i < t.length; i++) {
            if (t[i] != e) {
                n += e + "|"
            }
        }
        n = n.slice(0, -1);
        $.cookie("chatbox_minimized", n);
        $("#chatbox_" + e + " .chatboxcontent").css("display", "block");
        $("#chatbox_" + e + " .chatboxinput").css("display", "block");
        $("#chatbox_" + e + " .chatboxcontent").scrollTop($("#chatbox_" + e + " .chatboxcontent")[0].scrollHeight)
    } else {
        var n = e;
        if ($.cookie("chatbox_minimized")) {
            n += "|" + $.cookie("chatbox_minimized")
        }
        $.cookie("chatbox_minimized", n);
        $("#chatbox_" + e + " .chatboxcontent").css("display", "none");
        $("#chatbox_" + e + " .chatboxinput").css("display", "none")
    }
}

function checkChatBoxInputKey(e, t, n) {
    if (e.keyCode == 13 && e.shiftKey == 0) {
        message = $(t).val();
        message = message.replace(/^\s+|\s+$/g, "");
        $(t).val("");
        $(t).focus();
        $(t).css("height", "44px");
        if (message != "") {
            $.post("/chat/sendchat", {
                to: n,
                message: message
            }, function(e) {
                message = message.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;");
                $("#chatbox_" + n + " .chatboxcontent").append('<div class="chatboxmessage"><span class="chatboxmessagefrom">' + username + ':&nbsp;&nbsp;</span><span class="chatboxmessagecontent">' + message + "</span></div>");
                $("#chatbox_" + n + " .chatboxcontent").scrollTop($("#chatbox_" + n + " .chatboxcontent")[0].scrollHeight)
            })
        }
        chatHeartbeatTime = minChatHeartbeat;
        chatHeartbeatCount = 1;
        return false
    }
    var r = t.clientHeight;
    var i = 94;
    if (i > r) {
        r = Math.max(t.scrollHeight, r);
        if (i) r = Math.min(i, r);
        if (r > t.clientHeight) $(t).css("height", r + 8 + "px")
    } else {
        $(t).css("overflow", "auto")
    }
}

function startChatSession() {
    $.ajax({
        url: "/chat/startchatsession",
        cache: false,
        dataType: "json",
        success: function(e) {
            username = e.username;
            $.each(e.items, function(e, t) {
                if (t) {
                    chatboxtitle = t.f;
                    if ($("#chatbox_" + chatboxtitle).length <= 0) {
                        createChatBox(chatboxtitle, 1)
                    }
                    if (t.s == 1) {
                        t.f = username
                    }
                    if (t.s == 2) {
                        $("#chatbox_" + chatboxtitle + " .chatboxcontent").append('<div class="chatboxmessage"><span class="chatboxinfo">' + t.m + "</span></div>")
                    } else {
                        $("#chatbox_" + chatboxtitle + " .chatboxcontent").append('<div class="chatboxmessage"><span class="chatboxmessagefrom">' + t.f + ':&nbsp;&nbsp;</span><span class="chatboxmessagecontent">' + t.m + "</span></div>")
                    }
                }
            });
            
            for (i = 0; i < chatBoxes.length; i++) {
                chatboxtitle = chatBoxes[i];
                $("#chatbox_" + chatboxtitle + " .chatboxcontent").scrollTop($("#chatbox_" + chatboxtitle + " .chatboxcontent")[0].scrollHeight);
                setTimeout('$("#chatbox_"+chatboxtitle+" .chatboxcontent").scrollTop($("#chatbox_"+chatboxtitle+" .chatboxcontent")[0].scrollHeight);', 100)
            }
            setTimeout("chatHeartbeat();", chatHeartbeatTime)
        }
    })
}
var enableChat = true;
var windowFocus = true;
var username;
var chatHeartbeatCount = 0;
var minChatHeartbeat = 1e3;
var maxChatHeartbeat = 33e3;
var chatHeartbeatTime = minChatHeartbeat;
var originalTitle;
var blinkOrder = 0;
var chatboxFocus = new Array;
var newMessages = new Array;
var newMessagesWin = new Array;
var chatBoxes = new Array;
$(document).ready(function() {
    setTimeout(function() {
        if (enableChat == true) {
            originalTitle = document.title;
            startChatSession();
            $([window, document]).blur(function() {
                windowFocus = false
            }).focus(function() {
                windowFocus = true;
                document.title = originalTitle
            })
        }
    }, 2000)
});
jQuery.cookie = function(e, t, n) {
    if (typeof t != "undefined") {
        n = n || {};
        if (t === null) {
            t = "";
            n.expires = -1
        }
        var r = "";
        if (n.expires && (typeof n.expires == "number" || n.expires.toUTCString)) {
            var i;
            if (typeof n.expires == "number") {
                i = new Date;
                i.setTime(i.getTime() + n.expires * 24 * 60 * 60 * 1e3)
            } else {
                i = n.expires
            }
            r = "; expires=" + i.toUTCString()
        }
        var s = n.path ? "; path=" + n.path : "";
        var o = n.domain ? "; domain=" + n.domain : "";
        var u = n.secure ? "; secure" : "";
        document.cookie = [e, "=", encodeURIComponent(t), r, s, o, u].join("")
    } else {
        var a = null;
        if (document.cookie && document.cookie != "") {
            var f = document.cookie.split(";");
            for (var l = 0; l < f.length; l++) {
                var c = jQuery.trim(f[l]);
                if (c.substring(0, e.length + 1) == e + "=") {
                    a = decodeURIComponent(c.substring(e.length + 1));
                    break
                }
            }
        }
        return a
    }
}